<nav class="navbar navbar-expand-lg navbar-light bg-white mb-3" aria-label="Main navigation">
  <div class="container">
    <a class="navbar-brand" href="/">Secret Bay</a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="mainNav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="/about">About</a></li>
        <li class="nav-item"><a class="nav-link" href="/products">Browse</a></li>
        {% if current_user_is_seller %}
          <li class="nav-item"><a class="nav-link" href="{{ url_for('my_listings') }}">My Listings</a></li>
        {% endif %}
        {% if current_user_is_admin %}
          <li class="nav-item"><a class="nav-link" href="{{ url_for('admin_index') }}">Admin</a></li>
        {% endif %}
      </ul>

      <div class="d-flex align-items-center gap-2">
        <form class="d-flex" action="{{ url_for('products') }}" method="get" style="min-width:220px;">
          <input name="search" class="form-control form-control-sm me-2" type="search" placeholder="Search listings..." aria-label="Search" value="{{ request.args.get('search','') }}">
          <button class="btn btn-sm btn-primary" type="submit">Search</button>
        </form>

        <button id="theme-toggle" class="btn btn-sm btn-outline-secondary" title="Toggle dark mode">
          <span id="theme-icon">üåô</span>
        </button>

        <a href="{{ url_for('cart_view') }}" class="btn btn-outline-secondary position-relative">
          Cart <span id="cart-count" class="badge bg-primary ms-2">0</span>
        </a>

        {% if session.get('username') %}
          <div class="text-end">
            <div>Logged in as <strong>{{ session['username'] }}</strong></div>
            <a href="{{ url_for('logout') }}" class="small">Log out</a>
          </div>
        {% else %}
          <div>
            <a href="{{ url_for('login') }}" class="btn btn-sm btn-outline-primary me-1">Login</a>
            <a href="{{ url_for('register') }}" class="btn btn-sm btn-primary">Register</a>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</nav>

<script>
  // refresh cart badge on page load
  document.addEventListener('DOMContentLoaded', () => {
    fetch('{{ url_for("cart_summary") }}').then(r => r.json()).then(d => {
      const badge = document.getElementById('cart-count');
      if (badge) badge.textContent = d.total_items || 0;
    }).catch(()=>{});
  });

  // Dark mode toggle
  const themeToggle = document.getElementById('theme-toggle');
  const themeIcon = document.getElementById('theme-icon');

  // Load saved theme preference
  const savedTheme = localStorage.getItem('theme') || 'light';
  if (savedTheme === 'dark') {
    document.body.classList.add('dark-mode');
  }
  if (themeIcon) {
    themeIcon.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
  }

  if (themeToggle) {
    themeToggle.addEventListener('click', () => {
      const isDark = document.body.classList.toggle('dark-mode');
      const newTheme = isDark ? 'dark' : 'light';
      localStorage.setItem('theme', newTheme);
      if (themeIcon) {
        themeIcon.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
      }
    });
  }
</script>

<script>
  // Ensure favicon points to /favicon.ico (served from logo.png by the server)
  (function() {
    try {
      const replaceFavicon = () => {
        const head = document.head || document.getElementsByTagName('head')[0];
        if (!head) return;
        // Remove existing favicons
        document.querySelectorAll('link[rel="icon"], link[rel="shortcut icon"]').forEach(el => el.parentNode.removeChild(el));
        // Add our favicon link
        const link1 = document.createElement('link');
        link1.rel = 'icon';
        link1.type = 'image/png';
        link1.href = '/favicon.ico?v=2';
        head.appendChild(link1);
        // Legacy support for some browsers
        const link2 = document.createElement('link');
        link2.rel = 'shortcut icon';
        link2.type = 'image/png';
        link2.href = '/favicon.ico?v=2';
        head.appendChild(link2);
      };
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', replaceFavicon);
      } else {
        replaceFavicon();
      }
    } catch (e) { /* noop */ }
  })();
  </script>

<style>
  /* Dark mode styles */
  .dark-mode {
    background-color: #1a1d20 !important;
    color: #e9ecef !important;
  }
  
  .dark-mode .bg-white,
  .dark-mode .navbar,
  .dark-mode .listing-card,
  .dark-mode .card,
  .dark-mode .info-card,
  .dark-mode .profile-header {
    background-color: #2b3035 !important;
    color: #e9ecef !important;
    border-color: #495057 !important;
  }
  
  .dark-mode h1,
  .dark-mode h2,
  .dark-mode h3,
  .dark-mode h4,
  .dark-mode h5,
  .dark-mode h6 {
    color: #f8f9fa !important;
  }
  
  .dark-mode p,
  .dark-mode .description,
  .dark-mode label,
  .dark-mode .form-label {
    color: #dee2e6 !important;
  }
  
  .dark-mode .price {
    color: #28a745 !important;
    font-weight: bold;
  }
  
  .dark-mode .text-muted {
    color: #adb5bd !important;
  }
  
  .dark-mode .table {
    color: #e9ecef;
  }
  
  .dark-mode .table-striped tbody tr:nth-of-type(odd) {
    background-color: #1f2326;
  }
  
  .dark-mode .form-control,
  .dark-mode .form-select {
    background-color: #3a4046;
    color: #e9ecef;
    border-color: #6c757d;
  }
  
  .dark-mode .form-control::placeholder {
    color: #adb5bd;
  }
  
  .dark-mode .btn-outline-secondary {
    color: #e9ecef;
    border-color: #6c757d;
  }
  
  .dark-mode .btn-outline-secondary:hover {
    background-color: #495057;
    color: #fff;
  }
  
  .dark-mode .btn-outline-primary {
    color: #4dabf7;
    border-color: #4dabf7;
  }
  
  .dark-mode .btn-outline-primary:hover {
    background-color: #4dabf7;
    color: #fff;
  }
  
  .dark-mode .btn-primary {
    background-color: #0d6efd;
    border-color: #0d6efd;
    color: #fff;
  }
  
  .dark-mode .btn-success {
    background-color: #28a745;
    border-color: #28a745;
    color: #fff;
  }
  
  .dark-mode .bg-light,
  .dark-mode footer {
    background-color: #2b3035 !important;
    color: #e9ecef !important;
  }
  
  .dark-mode .border-top {
    border-color: #495057 !important;
  }
  
  .dark-mode a {
    color: #4dabf7 !important;
  }
  
  .dark-mode a:hover {
    color: #74c0fc !important;
  }
  
  .dark-mode .nav-link {
    color: #dee2e6 !important;
  }
  
  .dark-mode .nav-link:hover {
    color: #fff !important;
  }
  
  .dark-mode .navbar-brand {
    color: #fff !important;
  }
  
  .dark-mode .hero-section {
    background-color: #2b3035 !important;
    border-color: #495057 !important;
    color: #e9ecef !important;
  }
  
  .dark-mode .about-section {
    background-color: #2b3035 !important;
    border-color: #495057 !important;
    color: #e9ecef !important;
  }
  
  .dark-mode .alert {
    background-color: #3a4046 !important;
    color: #e9ecef !important;
    border-color: #6c757d !important;
  }
  
  .dark-mode .badge {
    color: #fff !important;
  }
  
  .dark-mode .out-of-stock-badge {
    background-color: #dc3545 !important;
    color: #fff !important;
  }
  
  .dark-mode input[type="number"],
  .dark-mode input[type="text"],
  .dark-mode input[type="email"],
  .dark-mode input[type="password"],
  .dark-mode textarea {
    background-color: #3a4046 !important;
    color: #e9ecef !important;
    border-color: #6c757d !important;
  }
  
  .dark-mode .company-statement {
    background-color: #2b3035 !important;
    border-color: #00a87e !important;
    color: #e9ecef !important;
  }
  
  .dark-mode .stock-badge.low {
    background-color: #ffc107 !important;
    color: #000 !important;
  }
  
  .dark-mode .stock-badge.out {
    background-color: #dc3545 !important;
    color: #fff !important;
  }
</style>