<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SailBay - Boats & Sailing Gear</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <!-- Leaflet CSS for map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --primary-color: #1e5a8e;
            --secondary-color: #f0f8ff;
            --accent-color: #FF6B35;
            --text-color: #2c3e50;
            --ocean-blue: #006994;
            --wave-color: #4a90e2;
            --bg-color: #ffffff;
            --card-bg: #ffffff;
            --border-color: #e9ecef;
        }

        /* Dark Mode - Ocean Night Theme */
        [data-theme="dark"] {
            --primary-color: #4a90e2;
            --secondary-color: #0a1929;
            --accent-color: #FF8C5A;
            --text-color: #e0e0e0;
            --ocean-blue: #1e5a8e;
            --wave-color: #2c5f8d;
            --bg-color: #0d1b2a;
            --card-bg: #1b2838;
            --border-color: #2d3748;
        }
        
        /* Map styling */
        #locationMap {
            z-index: 1;
        }
        
        [data-theme="dark"] .leaflet-tile {
            filter: brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3) brightness(0.7);
        }
        
        [data-theme="dark"] .leaflet-popup-content-wrapper {
            background-color: var(--card-bg);
            color: var(--text-color);
        }
        
        [data-theme="dark"] .leaflet-popup-tip {
            background-color: var(--card-bg);
        }

        body {
            background-color: var(--secondary-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .hero-section {
            position: relative;
            color: white;
            padding: 80px 0;
            margin-bottom: 40px;
            border-bottom: 3px solid var(--accent-color);
            overflow: hidden;
        }
        /* Ocean canvas as hero background */
        .hero-section #oceanCanvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }
        .hero-section::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(rgba(0,0,0,0.25), rgba(0,0,0,0.45));
            z-index: 1;
        }
        .hero-section .container { position: relative; z-index: 2; }
        [data-theme="dark"] .hero-section::after { background: linear-gradient(rgba(0,0,0,0.45), rgba(0,0,0,0.65)); }

        .weather-widget {
            color: var(--text-color) !important;
        }
        .weather-widget h4,
        .weather-widget .fw-bold,
        .weather-widget .text-muted {
            color: var(--text-color) !important;
        }

        .listing-card {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            padding: 15px;
            transition: transform 0.2s, background-color 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column;
            height: 100%;
            border: 1px solid var(--border-color);
        }

        .listing-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .listing-card .description-text {
            min-height: 48px;
            margin-bottom: 10px;
        }
        
        .listing-card .seller-info {
            margin-top: auto;
        }

        .price {
            color: var(--primary-color);
            font-size: 1.25rem;
            font-weight: bold;
        }

        .seller-info {
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .seller-name {
            font-weight: bold;
            color: var(--text-color);
        }

        .rating {
            color: #f39c12;
            margin-left: 5px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: var(--ocean-blue);
            border-color: var(--ocean-blue);
        }

        .out-of-stock-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #dc3545;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .category-card {
            cursor: pointer;
            border: 2px solid var(--border-color);
            background: var(--card-bg);
            transition: all 0.3s ease;
        }

        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-color: var(--primary-color);
        }

        .category-card h6 {
            margin: 0;
            color: var(--text-color);
            font-weight: 600;
        }

        .stats-section {
            background: var(--card-bg);
            padding: 40px 0;
            margin: 40px 0;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease;
        }

        .stat-item {
            text-align: center;
            padding: 20px;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-label {
            color: #6c757d;
            font-size: 1rem;
            margin-top: 5px;
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .hero-section {
                padding: 40px 0;
            }

            .display-4 {
                font-size: 2rem;
            }

            .lead {
                font-size: 1rem;
            }

            .btn-lg {
                font-size: 1rem;
                padding: 0.5rem 1rem;
            }

            .stat-number {
                font-size: 2rem;
            }

            .stat-label {
                font-size: 0.9rem;
            }

            .category-card {
                margin-bottom: 15px;
            }

            .listing-card {
                padding: 12px;
            }

            .price {
                font-size: 1.1rem;
            }
        }

        @media (max-width: 576px) {
            .hero-section {
                padding: 30px 0;
            }

            .display-4 {
                font-size: 1.75rem;
            }

            .d-flex.gap-3 {
                flex-direction: column;
                gap: 10px !important;
            }

            .d-flex.gap-3 .btn {
                width: 100%;
            }

            .stat-number {
                font-size: 1.75rem;
            }

            .stats-section,
            .container > .row {
                padding: 20px 10px;
            }
        }

        /* Ocean visualization (when in standalone section) */
        .ocean-section {
            position: relative;
            margin: 30px 0 10px 0;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            background: linear-gradient(180deg, rgba(0, 105, 148, 0.8) 0%, rgba(0, 105, 148, 0.95) 100%);
        }
        .ocean-section #oceanCanvas {
            width: 100%;
            height: 260px;
            display: block;
        }
        .ocean-overlay {
            position: absolute;
            top: 12px;
            left: 16px;
            color: #ffffff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.6);
            z-index: 2;
        }
        .ocean-overlay h5 {
            margin: 0 0 2px 0;
            font-weight: 700;
        }
        .ocean-overlay small {
            opacity: 0.9;
        }
        .ocean-tooltip {
            position: absolute;
            padding: 6px 10px;
            background: rgba(255,255,255,0.95);
            color: #1b2838;
            border-radius: 6px;
            font-size: 0.85rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            pointer-events: none;
            transform: translate(-50%, -120%);
            white-space: nowrap;
            border: 1px solid var(--border-color);
            z-index: 10;
        }
        [data-theme="dark"] .ocean-tooltip {
            background: rgba(27, 40, 56, 0.98);
            color: var(--text-color);
            border-color: #203040;
        }
    </style>
</head>
<body>
    {% include 'navbar.html' %}

    <div class="hero-section">
        <canvas id="oceanCanvas" aria-hidden="true"></canvas>
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-8 text-center">
                    <h1 class="display-4 mb-4">Discover Boats & Sailing Gear</h1>
                    <p class="lead mb-4">Buy and sell sailboats, parts, rigging, safety equipment, and marine accessories.</p>
                    
                    <!-- Search Bar -->
                    <form action="{{ url_for('products') }}" method="get" class="mb-4">
                        <div class="input-group input-group-lg" style="max-width: 600px; margin: 0 auto;">
                            <input name="search" class="form-control" type="search" placeholder="Search for items..." aria-label="Search" value="{{ request.args.get('search','') }}">
                            <button class="btn btn-primary" type="submit">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
                                    <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                                </svg>
                                Search
                            </button>
                        </div>
                    </form>
                    
                    <div class="d-flex justify-content-center gap-3 mb-5">
                        <a href="{{ url_for('products') }}" class="btn btn-primary btn-lg">Browse Listings</a>
                        {% if current_user_is_seller %}
                            <a href="{{ url_for('post_ad') }}" class="btn btn-outline-primary btn-lg">Post an Ad</a>
                        {% else %}
                            <a href="{{ url_for('register') }}" class="btn btn-outline-primary btn-lg">Post an Ad</a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sailing Conditions Widget -->
        <div class="container" style="position: relative; z-index: 2; margin-top: 3rem;">
            <div class="weather-widget mb-5 p-4" style="background: var(--card-bg); border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid var(--border-color); transition: background-color 0.3s ease;">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h4 class="mb-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-wind me-2" viewBox="0 0 16 16" style="vertical-align: -3px;">
                                <path d="M12.5 2A2.5 2.5 0 0 0 10 4.5a.5.5 0 0 1-1 0A3.5 3.5 0 1 1 12.5 8H.5a.5.5 0 0 1 0-1h12a2.5 2.5 0 0 0 0-5zm-7 1a1 1 0 0 0-1 1 .5.5 0 0 1-1 0 2 2 0 1 1 2 2h-5a.5.5 0 0 1 0-1h5a1 1 0 0 0 0-2zM0 9.5A.5.5 0 0 1 .5 9h10.042a3 3 0 1 1-3 3 .5.5 0 0 1 1 0 2 2 0 1 0 2-2H.5a.5.5 0 0 1-.5-.5z"/>
                            </svg>
                            Today's Sailing Conditions
                        </h4>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="d-flex align-items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-thermometer-half me-3 text-primary" viewBox="0 0 16 16">
                                        <path d="M9.5 12.5a1.5 1.5 0 1 1-2-1.415V6.5a.5.5 0 0 1 1 0v4.585a1.5 1.5 0 0 1 1 1.415z"/>
                                        <path d="M5.5 2.5a2.5 2.5 0 0 1 5 0v7.55a3.5 3.5 0 1 1-5 0V2.5zM8 1a1.5 1.5 0 0 0-1.5 1.5v7.987l-.167.15a2.5 2.5 0 1 0 3.333 0l-.166-.15V2.5A1.5 1.5 0 0 0 8 1z"/>
                                    </svg>
                                    <div>
                                        <div class="text-muted small">Temperature</div>
                                        <div class="fw-bold" id="weather-temp">Loading...</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex align-items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-wind me-3 text-primary" viewBox="0 0 16 16">
                                        <path d="M12.5 2A2.5 2.5 0 0 0 10 4.5a.5.5 0 0 1-1 0A3.5 3.5 0 1 1 12.5 8H.5a.5.5 0 0 1 0-1h12a2.5 2.5 0 0 0 0-5zm-7 1a1 1 0 0 0-1 1 .5.5 0 0 1-1 0 2 2 0 1 1 2 2h-5a.5.5 0 0 1 0-1h5a1 1 0 0 0 0-2zM0 9.5A.5.5 0 0 1 .5 9h10.042a3 3 0 1 1-3 3 .5.5 0 0 1 1 0 2 2 0 1 0 2-2H.5a.5.5 0 0 1-.5-.5z"/>
                                    </svg>
                                    <div>
                                        <div class="text-muted small">Wind Speed</div>
                                        <div class="fw-bold" id="weather-wind">Loading...</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex align-items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-cloud-sun me-3 text-primary" viewBox="0 0 16 16">
                                        <path d="M7 8a3.5 3.5 0 0 1 3.5 3.555.5.5 0 0 0 .624.492A1.503 1.503 0 0 1 13 13.5a1.5 1.5 0 0 1-1.5 1.5H3a2 2 0 1 1 .1-3.998.5.5 0 0 0 .51-.375A3.502 3.502 0 0 1 7 8zm4.473 3a4.5 4.5 0 0 0-8.72-.99A3 3 0 0 0 3 16h8.5a2.5 2.5 0 0 0 0-5h-.027z"/>
                                        <path d="M10.5 1.5a.5.5 0 0 0-1 0v1a.5.5 0 0 0 1 0v-1zm3.743 1.964a.5.5 0 1 0-.707-.707l-.708.707a.5.5 0 0 0 .708.708l.707-.708zm-7.779-.707a.5.5 0 0 0-.707.707l.707.708a.5.5 0 1 0 .708-.708l-.708-.707zm1.734 3.374a2 2 0 1 1 3.296 2.198c.199.281.372.584.516.898a3 3 0 1 0-4.84-3.225c.352.011.696.055 1.028.129zm4.484 4.074c.6.215 1.125.59 1.522 1.072a.5.5 0 0 0 .039-.742l-.707-.707a.5.5 0 0 0-.854.377zM14.5 6.5a.5.5 0 0 0 0 1h1a.5.5 0 0 0 0-1h-1z"/>
                                    </svg>
                                    <div>
                                        <div class="text-muted small">Conditions</div>
                                        <div class="fw-bold" id="weather-condition">Loading...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 text-center">
                        <div id="weather-icon" class="mb-2" style="font-size: 64px;">⛵</div>
                        <p class="text-muted mb-2 small" id="weather-location">Getting location...</p>
                        <button id="change-location-btn" class="btn btn-sm btn-outline-primary mb-2" onclick="showLocationModal()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-geo-alt me-1" viewBox="0 0 16 16" style="vertical-align: -2px;">
                                <path d="M12.166 8.94c-.524 1.062-1.234 2.12-1.96 3.07A31.493 31.493 0 0 1 8 14.58a31.481 31.481 0 0 1-2.206-2.57c-.726-.95-1.436-2.008-1.96-3.07C3.304 7.867 3 6.862 3 6a5 5 0 0 1 10 0c0 .862-.305 1.867-.834 2.94zM8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10z"/>
                                <path d="M8 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0 1a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
                            </svg>
                            Change Location
                        </button>
                        <p class="text-muted mb-0 small">
                            <span id="sailing-condition-badge" class="badge bg-success">Good Sailing</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="oceanTooltip" class="ocean-tooltip" style="display:none;"></div>
        <div id="popularProductsData" data-products='{{ popular_products|tojson|safe }}' hidden></div>
    </div>

    <div class="container">
        
        <!-- Location Modal -->
        <div class="modal fade" id="locationModal" tabindex="-1" aria-labelledby="locationModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content" style="background: var(--card-bg); color: var(--text-color);">
                    <div class="modal-header">
                        <h5 class="modal-title" id="locationModalLabel">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-geo-alt-fill me-2" viewBox="0 0 16 16">
                                <path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
                            </svg>
                            Set Your Location
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <!-- Left side: Search -->
                            <div class="col-md-5">
                                <div class="mb-3">
                                    <label for="citySearch" class="form-label fw-bold">Search Location:</label>
                                    <input type="text" class="form-control" id="citySearch" placeholder="Enter city or marina name...">
                                    <small class="text-muted">Try: Sydney, Newport RI, San Diego, Key West</small>
                                </div>
                                <div class="mb-3">
                                    <button class="btn btn-secondary w-100" onclick="useCurrentLocation()">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-crosshair me-2" viewBox="0 0 16 16">
                                            <path d="M8.5.5a.5.5 0 0 0-1 0v.518A7.001 7.001 0 0 0 1.018 7.5H.5a.5.5 0 0 0 0 1h.518A7.001 7.001 0 0 0 7.5 14.982v.518a.5.5 0 0 0 1 0v-.518A7.001 7.001 0 0 0 14.982 8.5h.518a.5.5 0 0 0 0-1h-.518A7.001 7.001 0 0 0 8.5 1.018V.5zm-6.48 7A6.001 6.001 0 0 1 7.5 2.02v.48a.5.5 0 0 0 1 0v-.48a6.001 6.001 0 0 1 5.48 5.48h-.48a.5.5 0 0 0 0 1h.48a6.001 6.001 0 0 1-5.48 5.48v-.48a.5.5 0 0 0-1 0v.48A6.001 6.001 0 0 1 2.02 8.5h.48a.5.5 0 0 0 0-1h-.48z"/>
                                        </svg>
                                        Use My Current Location
                                    </button>
                                </div>
                                <div id="locationError" class="alert alert-danger" style="display: none;"></div>
                                <div id="locationInfo" class="alert alert-info" style="display: none;">
                                    <strong id="selectedLocationName">Selected Location</strong><br>
                                    <small class="text-muted">
                                        Lat: <span id="selectedLat">-</span>, Lon: <span id="selectedLon">-</span>
                                    </small>
                                </div>
                                <div class="mt-3">
                                    <p class="small text-muted mb-2"><strong>Popular Sailing Destinations:</strong></p>
                                    <div class="d-flex flex-wrap gap-1">
                                        <button class="btn btn-sm btn-outline-primary" onclick="quickLocation('Sydney', -33.8688, 151.2093)">Sydney</button>
                                        <button class="btn btn-sm btn-outline-primary" onclick="quickLocation('Newport', 41.4901, -71.3128)">Newport RI</button>
                                        <button class="btn btn-sm btn-outline-primary" onclick="quickLocation('San Diego', 32.7157, -117.1611)">San Diego</button>
                                        <button class="btn btn-sm btn-outline-primary" onclick="quickLocation('Miami', 25.7617, -80.1918)">Miami</button>
                                        <button class="btn btn-sm btn-outline-primary" onclick="quickLocation('Auckland', -36.8485, 174.7633)">Auckland</button>
                                    </div>
                                </div>
                            </div>
                            <!-- Right side: Map -->
                            <div class="col-md-7">
                                <div id="locationMap" style="height: 400px; border-radius: 8px; border: 2px solid var(--border-color);"></div>
                                <small class="text-muted d-block mt-2">Click on the map to select a location</small>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="setLocationBtn" onclick="confirmLocation()" disabled>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-circle me-1" viewBox="0 0 16 16">
                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                <path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z"/>
                            </svg>
                            Set Location
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Featured Listings Section -->
        <h2 class="mb-4 mt-5">Featured Listings</h2>
        
        {% if featured_products and featured_products|length > 0 %}
        <!-- Carousel -->
        <style>
            #featuredCarousel .carousel-control-prev {
                left: -60px;
            }
            #featuredCarousel .carousel-control-next {
                right: -60px;
            }
            #featuredCarousel .carousel-control-prev-icon,
            #featuredCarousel .carousel-control-next-icon {
                background-color: rgba(0, 0, 0, 0.5);
                border-radius: 50%;
                width: 40px;
                height: 40px;
                padding: 8px;
            }
            @media (max-width: 768px) {
                #featuredCarousel .carousel-control-prev {
                    left: 0;
                }
                #featuredCarousel .carousel-control-next {
                    right: 0;
                }
                .carousel-item .col-md-4:nth-child(n+2) {
                    display: none;
                }
            }
            @media (min-width: 769px) and (max-width: 991px) {
                .carousel-item .col-md-4:nth-child(3) {
                    display: none;
                }
            }
        </style>
        <div id="featuredCarousel" class="carousel slide mb-5">
            <div class="carousel-indicators">
                {% set products_to_show = featured_products * 3 if featured_products|length < 3 else featured_products %}
                {% for i in range(0, products_to_show|length, 3) %}
                <button type="button" data-bs-target="#featuredCarousel" data-bs-slide-to="{{ loop.index0 }}" {% if loop.first %}class="active" aria-current="true"{% endif %} aria-label="Slide {{ loop.index }}"></button>
                {% endfor %}
            </div>
            <div class="carousel-inner">
                {% set products_to_show = featured_products * 3 if featured_products|length < 3 else featured_products %}
                {% for i in range(0, products_to_show|length, 3) %}
                <div class="carousel-item {% if loop.first %}active{% endif %}">
                    <div class="row g-3">
                        {% for p in products_to_show[i:i+3] %}
                        <div class="col-md-4">
                            <a href="{{ url_for('product_detail', product_id=p['id']) }}" class="text-decoration-none" style="color: inherit;">
                                <div class="listing-card position-relative h-100" style="cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 16px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)';">
                                    {% if p['stock'] is not none and p['stock'] == 0 %}
                                        <span class="out-of-stock-badge">Out of Stock</span>
                                    {% endif %}
                                    
                                    <!-- Product Image -->
                                    <div class="text-center mb-3" style="background: #f8f9fa; border-radius: 8px; padding: 15px; height: 250px; display: flex; align-items: center; justify-content: center;">
                                        {% if 'image_url' in p.keys() and p['image_url'] %}
                                            {% set img = p['image_url'] %}
                                            {% if img.startswith('http://') or img.startswith('https://') or img.startswith('/') %}
                                                <img src="{{ img }}" alt="{{ p['title'] }}" style="max-height: 100%; max-width: 100%; object-fit: contain;">
                                            {% else %}
                                                <img src="{{ url_for('static', filename='img/' ~ img) }}" alt="{{ p['title'] }}" style="max-height: 100%; max-width: 100%; object-fit: contain;">
                                            {% endif %}
                                        {% else %}
                                            <img src="https://via.placeholder.com/400x250/e9ecef/6c757d?text={{ p['title'][:20] }}" alt="{{ p['title'] }}" style="max-height: 100%; max-width: 100%; object-fit: contain;">
                                        {% endif %}
                                    </div>
                                    
                                    <h5 class="mb-2">{{ p['title'][:50] }}{% if p['title']|length > 50 %}...{% endif %}</h5>
                                    <p class="price mb-2">${{ '%.2f'|format(p['price']) }}</p>
                                    <div class="description-text">
                                        {% if p['description'] %}
                                            <p class="text-muted small mb-2">{{ p['description'][:80] }}{% if p['description']|length > 80 %}...{% endif %}</p>
                                        {% else %}
                                            <p class="text-muted small mb-2">&nbsp;</p>
                                        {% endif %}
                                    </div>
                                    <div class="seller-info mb-2">
                                        <span class="seller-name">{{ p['business_name'] or p['seller_username'] or 'Seller' }}</span>
                                        {% if p['rating'] %}
                                            <span class="rating">★ {{ '%.1f'|format(p['rating']) }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#featuredCarousel" data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#featuredCarousel" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Next</span>
            </button>
        </div>
        
        <script>
            // Make carousel truly infinite and continuous
            document.addEventListener('DOMContentLoaded', function() {
                const carousel = document.getElementById('featuredCarousel');
                if (carousel) {
                    const carouselInstance = new bootstrap.Carousel(carousel, {
                        interval: 3000,  // Auto-advance every 3 seconds
                        wrap: true,      // Enable looping
                        ride: 'carousel', // Start automatically
                        pause: 'hover'   // Pause on hover
                    });
                    
                    // Ensure smooth continuous scrolling
                    carousel.addEventListener('slid.bs.carousel', function () {
                        // Bootstrap handles the wrapping automatically with wrap: true
                    });
                }
            });
        </script>
        
        {% else %}
        <div class="text-center">
            <p>No featured listings available.</p>
        </div>
        {% endif %}

        <!-- Popular Categories Section -->
        <div class="my-5">
            <h3 class="mb-4 text-center">Browse Sailing Categories</h3>
            <div class="row row-cols-2 row-cols-md-3 row-cols-lg-6 g-3">
                <div class="col">
                    <a href="{{ url_for('products', category='Sailboats') }}" class="text-decoration-none">
                        <div class="card text-center h-100 category-card" style="transition: all 0.3s;">
                            <div class="card-body">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-laptop mb-2 text-primary" viewBox="0 0 16 16">
                                    <path d="M13.5 3a.5.5 0 0 1 .5.5V11H2V3.5a.5.5 0 0 1 .5-.5h11zm-11-1A1.5 1.5 0 0 0 1 3.5V12h14V3.5A1.5 1.5 0 0 0 13.5 2h-11zM0 12.5h16a1.5 1.5 0 0 1-1.5 1.5h-13A1.5 1.5 0 0 1 0 12.5z"/>
                                </svg>
                                <h6>Sailboats</h6>
                            </div>
                        </div>
                    </a>
                </div>
                <div class="col">
                    <a href="{{ url_for('products', category='Gear') }}" class="text-decoration-none">
                        <div class="card text-center h-100 category-card" style="transition: all 0.3s;">
                            <div class="card-body">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-house-door mb-2 text-success" viewBox="0 0 16 16">
                                    <path d="M8.354 1.146a.5.5 0 0 0-.708 0l-6 6A.5.5 0 0 0 1.5 7.5v7a.5.5 0 0 0 .5.5h4.5a.5.5 0 0 0 .5-.5v-4h2v4a.5.5 0 0 0 .5.5H14a.5.5 0 0 0 .5-.5v-7a.5.5 0 0 0-.146-.354L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293L8.354 1.146zM2.5 14V7.707l5.5-5.5 5.5 5.5V14H10v-4a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5v4H2.5z"/>
                                </svg>
                                <h6>Gear</h6>
                            </div>
                        </div>
                    </a>
                </div>
                <div class="col">
                    <a href="{{ url_for('products', category='Rigging') }}" class="text-decoration-none">
                        <div class="card text-center h-100 category-card" style="transition: all 0.3s;">
                            <div class="card-body">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-bag mb-2 text-danger" viewBox="0 0 16 16">
                                    <path d="M8 1a2.5 2.5 0 0 1 2.5 2.5V4h-5v-.5A2.5 2.5 0 0 1 8 1zm3.5 3v-.5a3.5 3.5 0 1 0-7 0V4H1v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V4h-3.5zM2 5h12v9a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V5z"/>
                                </svg>
                                <h6>Rigging</h6>
                            </div>
                        </div>
                    </a>
                </div>
                <div class="col">
                    <a href="{{ url_for('products', category='Sails') }}" class="text-decoration-none">
                        <div class="card text-center h-100 category-card" style="transition: all 0.3s;">
                            <div class="card-body">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-book mb-2 text-info" viewBox="0 0 16 16">
                                    <path d="M1 2.828c.885-.37 2.154-.769 3.388-.893 1.33-.134 2.458.063 3.112.752v9.746c-.935-.53-2.12-.603-3.213-.493-1.18.12-2.37.461-3.287.811V2.828zm7.5-.141c.654-.689 1.782-.886 3.112-.752 1.234.124 2.503.523 3.388.893v9.923c-.918-.35-2.107-.692-3.287-.81-1.094-.111-2.278-.039-3.213.492V2.687zM8 1.783C7.015.936 5.587.81 4.287.94c-1.514.153-3.042.672-3.994 1.105A.5.5 0 0 0 0 2.5v11a.5.5 0 0 0 .707.455c.882-.4 2.303-.881 3.68-1.02 1.409-.142 2.59.087 3.223.877a.5.5 0 0 0 .78 0c.633-.79 1.814-1.019 3.222-.877 1.378.139 2.8.62 3.681 1.02A.5.5 0 0 0 16 13.5v-11a.5.5 0 0 0-.293-.455c-.952-.433-2.48-.952-3.994-1.105C10.413.809 8.985.936 8 1.783z"/>
                                </svg>
                                <h6>Sails</h6>
                            </div>
                        </div>
                    </a>
                </div>
                <div class="col">
                    <a href="{{ url_for('products', category='Safety') }}" class="text-decoration-none">
                        <div class="card text-center h-100 category-card" style="transition: all 0.3s;">
                            <div class="card-body">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-trophy mb-2 text-warning" viewBox="0 0 16 16">
                                    <path d="M2.5.5A.5.5 0 0 1 3 0h10a.5.5 0 0 1 .5.5c0 .538-.012 1.05-.034 1.536a3 3 0 1 1-1.133 5.89c-.79 1.865-1.878 2.777-2.833 3.011v2.173l1.425.356c.194.048.377.135.537.255L13.3 15.1a.5.5 0 0 1-.3.9H3a.5.5 0 0 1-.3-.9l1.838-1.379c.16-.12.343-.207.537-.255L6.5 13.11v-2.173c-.955-.234-2.043-1.146-2.833-3.012a3 3 0 1 1-1.132-5.89A33.076 33.076 0 0 1 2.5.5zm.099 2.54a2 2 0 0 0 .72 3.935c-.333-1.05-.588-2.346-.72-3.935zm10.083 3.935a2 2 0 0 0 .72-3.935c-.133 1.59-.388 2.885-.72 3.935zM3.504 1c.007.517.026 1.006.056 1.469.13 2.028.457 3.546.87 4.667C5.294 9.48 6.484 10 7 10a.5.5 0 0 1 .5.5v2.61a1 1 0 0 1-.757.97l-1.426.356a.5.5 0 0 0-.179.085L4.5 15h7l-.638-.479a.501.501 0 0 0-.18-.085l-1.425-.356a1 1 0 0 1-.757-.97V10.5A.5.5 0 0 1 9 10c.516 0 1.706-.52 2.57-2.864.413-1.12.74-2.64.87-4.667.03-.463.049-.952.056-1.469H3.504z"/>
                                </svg>
                                <h6>Safety</h6>
                            </div>
                        </div>
                    </a>
                </div>
                <div class="col">
                    <a href="{{ url_for('products', category='Accessories') }}" class="text-decoration-none">
                        <div class="card text-center h-100 category-card" style="transition: all 0.3s;">
                            <div class="card-body">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-grid-3x3-gap mb-2 text-secondary" viewBox="0 0 16 16">
                                    <path d="M4 2v2H2V2h2zm1 12v-2a1 1 0 0 0-1-1H2a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h2a1 1 0 0 0 1-1zm0-5V7a1 1 0 0 0-1-1H2a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h2a1 1 0 0 0 1-1zm5 5v-2a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h2a1 1 0 0 0 1-1zm0-5V7a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h2a1 1 0 0 0 1-1zM9 2v2H7V2h2zm5 0v2h-2V2h2zM4 7v2H2V7h2zm5 0v2H7V7h2zm5 0h-2v2h2V7zM4 12v2H2v-2h2zm5 0v2H7v-2h2zm5 0v2h-2v-2h2zM12 1a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h2a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1h-2zm-1 6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1V7zm1 4a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h2a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1h-2z"/>
                                </svg>
                                <h6>Accessories</h6>
                            </div>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Section -->
    <div class="container">
        <div class="stats-section">
            <div class="row">
                <div class="col-md-4">
                    <div class="stat-item">
                        <div class="stat-number">{{ stats['active_listings'] if stats else '0' }}</div>
                        <div class="stat-label">Active Listings</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-item">
                        <div class="stat-number">{{ stats['total_sellers'] if stats else '0' }}</div>
                        <div class="stat-label">Trusted Sellers</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-item">
                        <div class="stat-number">{{ stats['total_users'] if stats else '0' }}+</div>
                        <div class="stat-label">Community Members</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- How It Works Section -->
    <div class="container my-5">
        <div class="py-5" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px;">
            <h3 class="mb-4 text-center text-white">How It Works</h3>
            <div class="row g-4 px-3">
                <div class="col-md-4">
                    <div class="text-center text-white">
                        <div class="mb-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
                                <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                            </svg>
                        </div>
                        <h5>1. Browse Listings</h5>
                        <p>Search through thousands of local listings or browse by category</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center text-white">
                        <div class="mb-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" class="bi bi-chat-dots" viewBox="0 0 16 16">
                                <path d="M5 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm4 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/>
                                <path d="m2.165 15.803.02-.004c1.83-.363 2.948-.842 3.468-1.105A9.06 9.06 0 0 0 8 15c4.418 0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7c0 1.76.743 3.37 1.97 4.6a10.437 10.437 0 0 1-.524 2.318l-.003.011a10.722 10.722 0 0 1-.244.637c-.079.186.074.394.273.362a21.673 21.673 0 0 0 .693-.125zm.8-3.108a1 1 0 0 0-.287-.801C1.618 10.83 1 9.468 1 8c0-3.192 3.004-6 7-6s7 2.808 7 6c0 3.193-3.004 6-7 6a8.06 8.06 0 0 1-2.088-.272 1 1 0 0 0-.711.074c-.387.196-1.24.57-2.634.893a10.97 10.97 0 0 0 .398-2z"/>
                            </svg>
                        </div>
                        <h5>2. Connect with Sellers</h5>
                        <p>Message sellers, ask questions, and arrange safe meetups</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center text-white">
                        <div class="mb-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" class="bi bi-bag-check" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M10.854 8.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708 0z"/>
                                <path d="M8 1a2.5 2.5 0 0 1 2.5 2.5V4h-5v-.5A2.5 2.5 0 0 1 8 1zm3.5 3v-.5a3.5 3.5 0 1 0-7 0V4H1v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V4h-3.5zM2 5h12v9a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V5z"/>
                            </svg>
                        </div>
                        <h5>3. Complete the Deal</h5>
                        <p>Buy or sell items safely in your local community</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recently Viewed Section -->
    {% if recently_viewed and recently_viewed|length > 0 %}
    <div class="container my-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3>
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" class="bi bi-clock-history me-2" viewBox="0 0 16 16">
                    <path d="M8.515 1.019A7 7 0 0 0 8 1V0a8 8 0 0 1 .589.022l-.074.997zm2.004.45a7.003 7.003 0 0 0-.985-.299l.219-.976c.383.086.76.2 1.126.342l-.36.933zm1.37.71a7.01 7.01 0 0 0-.439-.27l.493-.87a8.025 8.025 0 0 1 .979.654l-.615.789a6.996 6.996 0 0 0-.418-.302zm1.834 1.79a6.99 6.99 0 0 0-.653-.796l.724-.69c.27.285.52.59.747.91l-.818.576zm.744 1.352a7.08 7.08 0 0 0-.214-.468l.893-.45a7.976 7.976 0 0 1 .45 1.088l-.95.313a7.023 7.023 0 0 0-.179-.483zm.53 2.507a6.991 6.991 0 0 0-.1-1.025l.985-.17c.067.386.106.778.116 1.17l-1 .025zm-.131 1.538c.033-.17.06-.339.081-.51l.993.123a7.957 7.957 0 0 1-.23 1.155l-.964-.267c.046-.165.086-.332.12-.501zm-.952 2.379c.184-.29.346-.594.486-.908l.914.405c-.16.36-.345.706-.555 1.038l-.845-.535zm-.964 1.205c.122-.122.239-.248.35-.378l.758.653a8.073 8.073 0 0 1-.401.432l-.707-.707z"/>
                    <path d="M8 1a7 7 0 1 0 4.95 11.95l.707.707A8.001 8.001 0 1 1 8 0v1z"/>
                    <path d="M7.5 3a.5.5 0 0 1 .5.5v5.21l3.248 1.856a.5.5 0 0 1-.496.868l-3.5-2A.5.5 0 0 1 7 9V3.5a.5.5 0 0 1 .5-.5z"/>
                </svg>
                Recently Viewed
            </h3>
        </div>

        <div class="row row-cols-2 row-cols-md-4 g-3">
            {% for p in recently_viewed %}
                <div class="col">
                    <div class="card h-100 recently-viewed-card" style="transition: transform 0.2s;">
                        <a href="{{ url_for('product_detail', product_id=p['id']) }}" class="text-decoration-none text-dark">
                            {% if 'image_url' in p.keys() and p['image_url'] %}
                                {% set img = p['image_url'] %}
                                {% if img.startswith('http://') or img.startswith('https://') or img.startswith('/') %}
                                    <img src="{{ img }}" class="card-img-top" alt="{{ p['title'] }}" style="height: 180px; object-fit: contain; background: #fff; padding: 10px;">
                                {% else %}
                                    <img src="{{ url_for('static', filename='img/' ~ img) }}" class="card-img-top" alt="{{ p['title'] }}" style="height: 180px; object-fit: contain; background: #fff; padding: 10px;">
                                {% endif %}
                            {% else %}
                                <img src="https://via.placeholder.com/200x180?text=No+Image" class="card-img-top" alt="No image" style="height: 180px; object-fit: contain;">
                            {% endif %}
                            <div class="card-body p-3">
                                <h6 class="card-title mb-2" style="overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical;">{{ p['title'] }}</h6>
                                <p class="card-text text-success fw-bold mb-2">${{ '%.2f'|format(p['price']) }}</p>
                                {% if p['stock'] is not none and p['stock'] <= 0 %}
                                    <span class="badge bg-danger">Out of stock</span>
                                {% elif p['stock'] is not none and p['stock'] < 5 %}
                                    <span class="badge bg-warning text-dark">{{ p['stock'] }} left</span>
                                {% endif %}
                            </div>
                        </a>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    <script>
        // Add hover effect to recently viewed cards
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.recently-viewed-card').forEach(card => {
                card.addEventListener('mouseenter', () => {
                    card.style.transform = 'translateY(-5px)';
                    card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
                });
                card.addEventListener('mouseleave', () => {
                    card.style.transform = 'translateY(0)';
                    card.style.boxShadow = '';
                });
            });
        });
    </script>
    {% endif %}

    {% include 'footer.html' %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Leaflet JS for map -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Ocean Popularity Visualization Script -->
    <script>
        // Serialize popular products for the ocean visualization
        // Load product popularity data from hidden data attribute (avoids raw template braces inside JS)
        const POPULAR_PRODUCTS = (function(){
            const el = document.getElementById('popularProductsData');
            if (!el) return [];
            try { return JSON.parse(el.dataset.products || '[]'); } catch(e){ return []; }
        })();

        (function() {
            const canvas = document.getElementById('oceanCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const tooltip = document.getElementById('oceanTooltip');
            const overlay = document.getElementById('oceanOverlay');
            const container = canvas.parentElement;
            // Offscreen noise canvas for subtle ocean texture
            const noiseCanvas = document.createElement('canvas');
            const noiseCtx = noiseCanvas.getContext('2d');

            // Read CSS variables for theming
            function cssVar(name, fallback) {
                const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
                return v || fallback;
            }
            function hexToRgba(hex, alpha) {
                const h = hex.replace('#','');
                const bigint = parseInt(h, 16);
                const r = (bigint >> 16) & 255;
                const g = (bigint >> 8) & 255;
                const b = bigint & 255;
                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            }

            const colors = {
                ocean: cssVar('--ocean-blue', '#006994'),
                wave: cssVar('--wave-color', '#4a90e2'),
                accent: cssVar('--accent-color', '#FF6B35')
            };
            // Category color accents (stripe on deck)
            const categoryColors = {
                'Sailboats': '#2b8be3',
                'Rigging': '#e37b2b',
                'Safety': '#e32b4d',
                'Navigation': '#7b2be3',
                'Accessories': '#2be38c'
            };

            let dpr = window.devicePixelRatio || 1;
            let width = 0, height = 0;

            function buildNoise() {
                // Build a small tiled noise texture for water shimmer
                noiseCanvas.width = 128;
                noiseCanvas.height = 128;
                const id = noiseCtx.createImageData(noiseCanvas.width, noiseCanvas.height);
                for (let i = 0; i < id.data.length; i += 4) {
                    const v = Math.random() * 255;
                    id.data[i] = 0; // R
                    id.data[i+1] = 0; // G
                    id.data[i+2] = 0; // B
                    id.data[i+3] = v < 130 ? 0 : 24; // Sparse alpha speckles
                }
                noiseCtx.putImageData(id, 0, 0);
            }
            buildNoise();

            function resizeCanvas() {
                dpr = window.devicePixelRatio || 1;
                const rect = canvas.getBoundingClientRect();
                width = Math.max(300, Math.floor(rect.width));
                height = Math.max(180, Math.floor(rect.height));
                canvas.width = Math.floor(width * dpr);
                canvas.height = Math.floor(height * dpr);
                ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
            }
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            // Map products to boats
            const products = Array.isArray(POPULAR_PRODUCTS) ? POPULAR_PRODUCTS.slice(0, 12) : [];
            const boats = [];
            const wakeParticles = [];
            const now = () => performance.now();

            function rand(min, max) { return Math.random() * (max - min) + min; }
            // Randomly choose direction so boats spawn from all four directions

            // Compute popularity range for scaling (declared later after sorting)
            let maxViewCount = 1;

            function addBoatForProduct(p) {
                // Choose random direction: 0=right, 1=down, 2=left, 3=up
                const direction = Math.floor(Math.random() * 4);
                let startX, startY, baseHeading, speedX, speedY;
                const baseSpeed = rand(12, 25);
                
                switch(direction) {
                    case 0: // From left, moving right
                        startX = rand(-140, -20);
                        startY = rand(height * 0.3, height * 0.85);
                        baseHeading = 0;
                        speedX = baseSpeed;
                        speedY = 0;
                        break;
                    case 1: // From top, moving down
                        startX = rand(width * 0.2, width * 0.8);
                        startY = rand(-140, -20);
                        baseHeading = Math.PI / 2;
                        speedX = 0;
                        speedY = baseSpeed;
                        break;
                    case 2: // From right, moving left
                        startX = rand(width + 20, width + 160);
                        startY = rand(height * 0.3, height * 0.85);
                        baseHeading = Math.PI;
                        speedX = -baseSpeed;
                        speedY = 0;
                        break;
                    case 3: // From bottom, moving up
                        startX = rand(width * 0.2, width * 0.8);
                        startY = rand(height + 20, height + 160);
                        baseHeading = -Math.PI / 2;
                        speedX = 0;
                        speedY = -baseSpeed;
                        break;
                }
                
                const popularity = Number(p.view_count || 0);
                const popularityRatio = Math.min(popularity / maxViewCount, 1);
                const popularityScale = 1.0 + popularityRatio * 1.0; // 1.0 - 2.0 range (increased from 0.85-1.5)
                const length = rand(50, 75) * popularityScale; // boat length scaled by popularity (increased base size)
                const amplitude = rand(0.8, 2.2); // reduced bob amplitude per user request
                const frequency = rand(0.0015, 0.003);
                const phase = rand(0, Math.PI * 2);
                const jitter = rand(-0.08, 0.08); // minor deviation only
                const theta = baseHeading + jitter; // heading primary direction
                // Tiering based on popularity ratio
                let tier = 1;
                if (popularityRatio > 0.33) tier = 2;
                if (popularityRatio > 0.66) tier = 3;
                boats.push({
                    id: p.id,
                    title: p.title,
                    price: p.price,
                    category: p.category,
                    image_url: p.image_url,
                    viewCount: popularity,
                    popularityRatio,
                    tier,
                    headingJitter: jitter,
                    x: startX,
                    y: startY,
                    baseY: startY,
                    baseX: startX,
                    speedX,
                    speedY,
                    direction,
                    len: length,
                    amp: amplitude,
                    freq: frequency,
                    phase,
                    theta,
                    hover: false,
                    imageLoaded: false,
                    image: null
                });
            }

            // Hard cap total boats for clarity & performance
            const MAX_BOATS = 12; // global upper limit (previously scaled by screen size)
            // Sort by popularity (view_count desc) and take top products
            const sorted = products.slice().sort((a,b) => (Number(b.view_count||0) - Number(a.view_count||0)));
            maxViewCount = sorted.reduce((m, p) => Math.max(m, Number(p.view_count||0)), 0) || 1;
            const selected = sorted.slice(0, MAX_BOATS);
            // One boat per selected product (removed extra duplicates for simpler view)
            selected.forEach(p => addBoatForProduct(p));

            // Load images for boats
            boats.forEach(boat => {
                if (boat.image_url) {
                    const img = new Image();
                    img.crossOrigin = "anonymous"; // Allow cross-origin if needed
                    img.onload = () => {
                        boat.imageLoaded = true;
                        boat.image = img;
                    };
                    img.onerror = () => {
                        boat.imageLoaded = false; // Failed to load
                    };
                    img.src = boat.image_url;
                }
            });

            function drawBackground(t) {
                // Vertical gradient (deeper darker)
                const grad = ctx.createLinearGradient(0, 0, 0, height);
                grad.addColorStop(0, hexToRgba(colors.ocean, 0.75));
                grad.addColorStop(0.55, hexToRgba(colors.ocean, 0.92));
                grad.addColorStop(1, hexToRgba(colors.ocean, 1.0));
                ctx.fillStyle = grad;
                ctx.fillRect(0, 0, width, height);

                // Dynamic wave bands with slight perspective skew
                const layers = [
                    { amp: 12, wl: 210, spd: 0.25, alpha: 0.22, shade: colors.wave },
                    { amp: 8,  wl: 140, spd: 0.45, alpha: 0.18, shade: colors.wave },
                    { amp: 5,  wl: 90,  spd: 0.75, alpha: 0.14, shade: colors.wave }
                ];
                layers.forEach((L, idx) => {
                    ctx.beginPath();
                    for (let x = 0; x <= width; x += 3) {
                        const y = height * 0.58 + Math.sin((x / L.wl) + t * L.spd) * L.amp + idx * 6;
                        // Parallax skew: shift based on layer index
                        const sx = x + Math.sin(t * 0.15 + idx) * idx * 2;
                        if (x === 0) ctx.moveTo(sx, y); else ctx.lineTo(sx, y);
                    }
                    ctx.lineTo(width, height);
                    ctx.lineTo(0, height);
                    ctx.closePath();
                    ctx.fillStyle = hexToRgba(L.shade, L.alpha);
                    ctx.fill();
                });

                // Shimmer texture (scrolling noise)
                ctx.globalAlpha = 0.13;
                const scrollX = (t * 12) % noiseCanvas.width;
                const scrollY = (t * 6) % noiseCanvas.height;
                for (let y = -noiseCanvas.height; y < height + noiseCanvas.height; y += noiseCanvas.height) {
                    for (let x = -noiseCanvas.width; x < width + noiseCanvas.width; x += noiseCanvas.width) {
                        ctx.drawImage(noiseCanvas, Math.floor(x + scrollX), Math.floor(y + scrollY));
                    }
                }
                ctx.globalAlpha = 1;

                // Soft horizon glow
                const glowGrad = ctx.createLinearGradient(0, height * 0.45, 0, height);
                glowGrad.addColorStop(0, hexToRgba('#ffffff', 0.05));
                glowGrad.addColorStop(1, 'rgba(255,255,255,0)');
                ctx.fillStyle = glowGrad;
                ctx.fillRect(0, 0, width, height);
            }

            function drawBoat(b, t) {
                const x = b.x;
                const y = b.baseY + Math.sin(t * 1000 * b.freq + b.phase) * b.amp;
                const len = b.len;
                const beam = Math.max(12, len * 0.38); // boat width (increased from 0.32)
                const halfL = len * 0.5;

                // Maintain main travel direction with slight preserved jitter (reduced oscillation)
                const heading = (b.theta || 0) + Math.sin(t * 0.4 + b.phase) * 0.012; // further reduced oscillation
                b.heading = heading;
                b.drawY = y;

                // Highlight for hover state
                const baseHull = b.hover ? colors.accent : '#ffffff';
                // Deck gradient
                const deckGrad = ctx.createLinearGradient(x - halfL, y, x + halfL, y);
                deckGrad.addColorStop(0, hexToRgba(baseHull, 0.85));
                deckGrad.addColorStop(0.5, hexToRgba(baseHull, 1.0));
                deckGrad.addColorStop(1, hexToRgba(baseHull, 0.85));
                const strokeColor = b.hover ? hexToRgba('#000000', 0.45) : hexToRgba('#000000', 0.25);
                const stripeColor = categoryColors[b.category] || '#1e90ff';

                ctx.save();
                ctx.translate(x, y);
                ctx.rotate(heading);

                // Hull (capsule shape - rounded rectangle along X axis)
                const r = beam * 0.5;
                ctx.beginPath();
                ctx.moveTo(-halfL + r, -r);
                ctx.lineTo(halfL - r, -r);
                ctx.arc(halfL - r, 0, r, -Math.PI/2, Math.PI/2);
                ctx.lineTo(-halfL + r, r);
                ctx.arc(-halfL + r, 0, r, Math.PI/2, -Math.PI/2);
                ctx.closePath();
                ctx.fillStyle = deckGrad;
                ctx.fill();
                ctx.lineWidth = b.hover ? 2 : 1;
                ctx.strokeStyle = strokeColor;
                ctx.stroke();

                // Category stripe (centerline)
                ctx.beginPath();
                ctx.roundRect(-halfL * 0.6, -beam * 0.15, halfL * 1.2, beam * 0.3, beam * 0.12);
                ctx.fillStyle = hexToRgba(stripeColor, b.hover ? 0.9 : 0.55);
                ctx.fill();
                ctx.globalAlpha = 1;

                // Product image (if loaded)
                if (b.imageLoaded && b.image) {
                    ctx.save();
                    // Create circular clipping region for image
                    const imgSize = Math.min(len * 0.35, beam * 0.9);
                    const imgX = -len * 0.15; // Position towards stern
                    const imgY = 0;
                    
                    ctx.beginPath();
                    ctx.arc(imgX, imgY, imgSize * 0.5, 0, Math.PI * 2);
                    ctx.clip();
                    
                    // Draw image centered in circle
                    ctx.drawImage(
                        b.image,
                        imgX - imgSize * 0.5,
                        imgY - imgSize * 0.5,
                        imgSize,
                        imgSize
                    );
                    
                    ctx.restore();
                    
                    // Add border around image
                    ctx.beginPath();
                    ctx.arc(imgX, imgY, imgSize * 0.5, 0, Math.PI * 2);
                    ctx.strokeStyle = hexToRgba('#ffffff', b.hover ? 0.8 : 0.6);
                    ctx.lineWidth = b.hover ? 2.5 : 1.5;
                    ctx.stroke();
                }

                // Tier extras
                if (b.tier >= 2) {
                    // Flag at bow
                    ctx.beginPath();
                    ctx.moveTo(halfL * 0.4, -beam * 0.05);
                    ctx.lineTo(halfL * 0.55, -beam * 0.25);
                    ctx.lineTo(halfL * 0.55, beam * 0.0);
                    ctx.closePath();
                    ctx.fillStyle = hexToRgba(stripeColor, b.hover ? 0.85 : 0.6);
                    ctx.fill();
                }
                if (b.tier >= 3) {
                    // Portholes along hull
                    const holeCount = Math.max(3, Math.floor(len / 30));
                    for (let i = 0; i < holeCount; i++) {
                        const fx = -halfL * 0.4 + (i / (holeCount - 1)) * (halfL * 0.8);
                        ctx.beginPath();
                        ctx.arc(fx, beam * 0.28, beam * 0.11, 0, Math.PI * 2);
                        ctx.fillStyle = hexToRgba('#000000', b.hover ? 0.55 : 0.35);
                        ctx.fill();
                        ctx.beginPath();
                        ctx.arc(fx, beam * 0.28, beam * 0.06, 0, Math.PI * 2);
                        ctx.fillStyle = hexToRgba('#ffffff', b.hover ? 0.75 : 0.55);
                        ctx.fill();
                    }
                }

                // Bow marker (small triangle at the front)
                ctx.beginPath();
                ctx.moveTo(halfL - 1, 0);
                ctx.lineTo(halfL * 0.75, -beam * 0.25);
                ctx.lineTo(halfL * 0.75, beam * 0.25);
                ctx.closePath();
                ctx.fillStyle = hexToRgba('#ffffff', 0.9);
                ctx.fill();

                // Mast dot (decorative)
                ctx.beginPath();
                ctx.arc(0, 0, Math.max(1.5, beam * 0.08), 0, Math.PI * 2);
                ctx.fillStyle = colors.accent;
                ctx.fill();

                // Wake behind stern (scale with tier)
                const wakeLenScale = b.tier === 3 ? 0.38 : b.tier === 2 ? 0.30 : 0.25;
                const wakeWidthScale = b.tier === 3 ? 0.22 : b.tier === 2 ? 0.20 : 0.18;
                ctx.globalAlpha = 0.18 + (b.tier - 1) * 0.05;
                ctx.beginPath();
                ctx.moveTo(-halfL, 0);
                ctx.lineTo(-halfL - len * wakeLenScale, -beam * wakeWidthScale);
                ctx.lineTo(-halfL - len * wakeLenScale, beam * wakeWidthScale);
                ctx.closePath();
                ctx.fillStyle = '#ffffff';
                ctx.fill();
                ctx.globalAlpha = 1;

                // Soft shadow (ellipse) beneath boat for depth
                ctx.save();
                ctx.rotate(-heading); // Cancel rotation for shadow alignment with water surface
                ctx.globalAlpha = 0.15;
                ctx.fillStyle = '#000000';
                ctx.beginPath();
                ctx.ellipse(0, 0, halfL * 0.55, beam * 0.55, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;
                ctx.restore();

                ctx.restore();

                // Update cached screen bounds for hit testing (in CSS px coordinates)
                b.screenX = x - halfL;
                b.screenY = y - beam * 0.5;
                b.boxW = len;
                b.boxH = beam;
            }

            let last = now();
            
            // Collision detection helper
            function checkCollision(boat1, boat2) {
                const dx = boat1.x - boat2.x;
                const dy = boat1.y - boat2.y;
                const minDist = (boat1.len + boat2.len) / 2 + 20; // Add buffer
                const dist = Math.sqrt(dx * dx + dy * dy);
                return dist < minDist;
            }
            
            // Adjust boat positions to avoid collisions
            function avoidCollisions() {
                for (let i = 0; i < boats.length; i++) {
                    for (let j = i + 1; j < boats.length; j++) {
                        if (checkCollision(boats[i], boats[j])) {
                            // Move boats apart vertically
                            const dy = boats[i].y - boats[j].y;
                            const separation = 30;
                            if (Math.abs(dy) < separation) {
                                boats[i].y += separation / 2;
                                boats[j].y -= separation / 2;
                                // Keep within bounds
                                boats[i].y = Math.max(40, Math.min(height - 40, boats[i].y));
                                boats[j].y = Math.max(40, Math.min(height - 40, boats[j].y));
                                boats[i].baseY = boats[i].y;
                                boats[j].baseY = boats[j].y;
                            }
                        }
                    }
                }
            }
            
            function tick() {
                const t = now();
                const dt = (t - last) / 1000; // seconds
                last = t;

                drawBackground(t / 1000);

                // Update & draw wake particles (behind boats, before drawing boats so boats appear above)
                for (let i = wakeParticles.length - 1; i >= 0; i--) {
                    const wp = wakeParticles[i];
                    wp.age += dt;
                    if (wp.age >= wp.life) { wakeParticles.splice(i,1); continue; }
                    const alpha = 1 - (wp.age / wp.life);
                    ctx.save();
                    ctx.globalAlpha = alpha * 0.35;
                    ctx.fillStyle = '#ffffff';
                    ctx.beginPath();
                    ctx.ellipse(wp.x, wp.y, wp.radius * (1 + wp.age * 1.3), wp.radius * 0.6 * (1 + wp.age), 0, 0, Math.PI*2);
                    ctx.fill();
                    ctx.restore();
                }

                boats.forEach(b => {
                    b.x += b.speedX * dt;
                    b.y += b.speedY * dt;
                    
                    // Respawn logic based on direction
                    let needsRespawn = false;
                    switch(b.direction) {
                        case 0: // Moving right
                            if (b.x - b.len > width + 10) needsRespawn = true;
                            break;
                        case 1: // Moving down
                            if (b.y - b.len > height + 10) needsRespawn = true;
                            break;
                        case 2: // Moving left
                            if (b.x + b.len < -10) needsRespawn = true;
                            break;
                        case 3: // Moving up
                            if (b.y + b.len < -10) needsRespawn = true;
                            break;
                    }
                    
                    if (needsRespawn) {
                        // Choose new random direction
                        b.direction = Math.floor(Math.random() * 4);
                        const baseSpeed = rand(12, 25);
                        
                        switch(b.direction) {
                            case 0: // From left, moving right
                                b.x = rand(-140, -20);
                                b.y = rand(height * 0.3, height * 0.85);
                                b.theta = 0 + b.headingJitter;
                                b.speedX = baseSpeed;
                                b.speedY = 0;
                                break;
                            case 1: // From top, moving down
                                b.x = rand(width * 0.2, width * 0.8);
                                b.y = rand(-140, -20);
                                b.theta = Math.PI / 2 + b.headingJitter;
                                b.speedX = 0;
                                b.speedY = baseSpeed;
                                break;
                            case 2: // From right, moving left
                                b.x = rand(width + 20, width + 160);
                                b.y = rand(height * 0.3, height * 0.85);
                                b.theta = Math.PI + b.headingJitter;
                                b.speedX = -baseSpeed;
                                b.speedY = 0;
                                break;
                            case 3: // From bottom, moving up
                                b.x = rand(width * 0.2, width * 0.8);
                                b.y = rand(height + 20, height + 160);
                                b.theta = -Math.PI / 2 + b.headingJitter;
                                b.speedX = 0;
                                b.speedY = -baseSpeed;
                                break;
                        }
                        b.baseY = b.y;
                        b.baseX = b.x;
                    }
                    // Spawn wake particle at stern occasionally
                    if (Math.random() < 0.6) {
                        const sternOffset = b.len * -0.5; // stern in local coords
                        const heading = b.heading || b.theta || 0;
                        const y = b.drawY !== undefined ? b.drawY : b.baseY;
                        const sx = b.x + Math.cos(heading) * sternOffset;
                        const sy = y + Math.sin(heading) * sternOffset;
                        wakeParticles.push({
                            x: sx + rand(-1.5,1.5),
                            y: sy + rand(-1.5,1.5),
                            radius: Math.max(2.2, b.len * (b.tier === 3 ? 0.055 : b.tier === 2 ? 0.045 : 0.035)),
                            age: 0,
                            life: rand(0.8, 1.8)
                        });
                    }
                    drawBoat(b, t / 1000);
                });

                // Prevent boat collisions
                avoidCollisions();

                requestAnimationFrame(tick);
            }

            // Interactions
            function setTooltip(content, x, y) {
                if (!tooltip) return;
                tooltip.innerHTML = content;
                const rect = container.getBoundingClientRect();
                tooltip.style.left = `${x - rect.left}px`;
                tooltip.style.top = `${y - rect.top}px`;
                tooltip.style.display = 'block';
            }
            function hideTooltip() {
                if (tooltip) tooltip.style.display = 'none';
            }
            function hitTest(mx, my) {
                // Rotated rectangle hit test using boat's heading
                for (let i = boats.length - 1; i >= 0; i--) {
                    const b = boats[i];
                    if (!b) continue;
                    const len = b.len;
                    const beam = Math.max(10, len * 0.32);
                    const heading = b.heading || b.theta || 0;
                    const y = b.drawY !== undefined ? b.drawY : b.baseY;
                    const dx = mx - b.x;
                    const dy = my - y;
                    const cosH = Math.cos(-heading);
                    const sinH = Math.sin(-heading);
                    // Rotate point into boat local space
                    const rx = dx * cosH - dy * sinH;
                    const ry = dx * sinH + dy * cosH;
                    if (rx >= -len/2 && rx <= len/2 && ry >= -beam/2 && ry <= beam/2) {
                        return b;
                    }
                }
                return null;
            }

            canvas.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                const mx = e.clientX - rect.left;
                const my = e.clientY - rect.top;
                let hovered = false;
                const b = hitTest(mx, my);
                boats.forEach(boat => boat.hover = false);
                if (b) {
                    b.hover = true;
                    hovered = true;
                    canvas.style.cursor = 'pointer';
                    setTooltip(`${b.title} — $${Number(b.price).toFixed(2)}`, e.clientX, e.clientY);
                } else {
                    canvas.style.cursor = 'default';
                    hideTooltip();
                }
            });
            canvas.addEventListener('mouseleave', hideTooltip);
            canvas.addEventListener('click', (e) => {
                const rect = canvas.getBoundingClientRect();
                const mx = e.clientX - rect.left;
                const my = e.clientY - rect.top;
                const b = hitTest(mx, my);
                if (b && b.id) {
                    window.location.href = `/product/${b.id}`;
                }
            });

            // If no popular products, tweak overlay message
            if (!products || products.length === 0) {
                if (overlay) {
                    overlay.querySelector('small').textContent = 'No popularity data yet — check back soon';
                }
            }

            requestAnimationFrame(tick);
        })();
    </script>
    
    <script>
        // Weather Widget - Uses OpenWeatherMap free API
        const apiKey = '519386db5aaeba4964ff7ee4f20c0a42';
        
        // Map variables
        let locationMap = null;
        let mapMarker = null;
        let selectedLocation = null;
        
        async function loadWeather(lat = null, lon = null, cityName = null) {
            try {
                // Get saved location or use default
                const savedLocation = localStorage.getItem('weatherLocation');
                if (!lat && !lon && savedLocation) {
                    const saved = JSON.parse(savedLocation);
                    lat = saved.lat;
                    lon = saved.lon;
                    cityName = saved.name;
                }
                
                // Default to a coastal sailing location (Sydney, Australia)
                if (!lat || !lon) {
                    lat = -33.8688;
                    lon = 151.2093;
                    cityName = cityName || 'Sydney Harbour';
                }
                
                // Fetch real weather data
                const response = await fetch(
                    `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric`
                );
                const data = await response.json();
                
                // Save location
                localStorage.setItem('weatherLocation', JSON.stringify({
                    lat: lat,
                    lon: lon,
                    name: data.name || cityName
                }));
                
                // Update UI
                document.getElementById('weather-temp').textContent = `${Math.round(data.main.temp)}°C`;
                document.getElementById('weather-wind').textContent = `${Math.round(data.wind.speed)} knots`;
                document.getElementById('weather-condition').textContent = data.weather[0].main;
                document.getElementById('weather-location').textContent = data.name || cityName;
                
                // Determine sailing conditions
                const windSpeed = data.wind.speed;
                const badge = document.getElementById('sailing-condition-badge');
                
                if (windSpeed < 5) {
                    badge.textContent = 'Light Winds';
                    badge.className = 'badge bg-warning';
                } else if (windSpeed < 15) {
                    badge.textContent = 'Good Sailing';
                    badge.className = 'badge bg-success';
                } else if (windSpeed < 25) {
                    badge.textContent = 'Strong Winds';
                    badge.className = 'badge bg-info';
                } else {
                    badge.textContent = 'Gale Warning';
                    badge.className = 'badge bg-danger';
                }
                
                // Update weather icon
                const icon = document.getElementById('weather-icon');
                const condition = data.weather[0].main.toLowerCase();
                if (condition.includes('clear')) {
                    icon.textContent = '☀️';
                } else if (condition.includes('cloud')) {
                    icon.textContent = '⛅';
                } else if (condition.includes('rain')) {
                    icon.textContent = '🌧️';
                } else if (condition.includes('storm')) {
                    icon.textContent = '⛈️';
                } else {
                    icon.textContent = '⛵';
                }
                
            } catch (error) {
                console.error('Weather API error:', error);
                // Show fallback demo data
                document.getElementById('weather-temp').textContent = '22°C';
                document.getElementById('weather-wind').textContent = '12 knots';
                document.getElementById('weather-condition').textContent = 'Clear';
                document.getElementById('weather-location').textContent = 'Demo Location';
                document.getElementById('weather-icon').textContent = '☀️';
                document.getElementById('sailing-condition-badge').textContent = 'Good Sailing';
                document.getElementById('sailing-condition-badge').className = 'badge bg-success';
            }
        }
        
        // Initialize map when modal is shown
        function showLocationModal() {
            const modal = new bootstrap.Modal(document.getElementById('locationModal'));
            modal.show();
            
            // Initialize map after modal is shown
            setTimeout(() => {
                if (!locationMap) {
                    // Create map centered on world view
                    locationMap = L.map('locationMap').setView([20, 0], 2);
                    
                    // Add OpenStreetMap tiles (reverted from satellite)
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenStreetMap contributors',
                        maxZoom: 18
                    }).addTo(locationMap);
                    
                    // Add click event to map
                    locationMap.on('click', async function(e) {
                        const lat = e.latlng.lat;
                        const lon = e.latlng.lng;
                        
                        // Remove existing marker
                        if (mapMarker) {
                            locationMap.removeLayer(mapMarker);
                        }
                        
                        // Add new marker
                        mapMarker = L.marker([lat, lon]).addTo(locationMap);
                        
                        // Get location name via reverse geocoding
                        try {
                            const response = await fetch(`https://api.openweathermap.org/geo/1.0/reverse?lat=${lat}&lon=${lon}&limit=1&appid=${apiKey}`);
                            const data = await response.json();
                            const locationName = data.length > 0 ? `${data[0].name}, ${data[0].country}` : 'Selected Location';
                            
                            mapMarker.bindPopup(locationName).openPopup();
                            
                            // Store selected location
                            selectedLocation = {
                                lat: lat,
                                lon: lon,
                                name: data.length > 0 ? data[0].name : 'Custom Location'
                            };
                            
                            // Update info display
                            document.getElementById('selectedLocationName').textContent = locationName;
                            document.getElementById('selectedLat').textContent = lat.toFixed(4);
                            document.getElementById('selectedLon').textContent = lon.toFixed(4);
                            document.getElementById('locationInfo').style.display = 'block';
                            document.getElementById('setLocationBtn').disabled = false;
                            
                        } catch (error) {
                            console.error('Reverse geocoding failed:', error);
                            mapMarker.bindPopup(`Lat: ${lat.toFixed(4)}, Lon: ${lon.toFixed(4)}`).openPopup();
                            
                            selectedLocation = {
                                lat: lat,
                                lon: lon,
                                name: 'Selected Location'
                            };
                            
                            document.getElementById('setLocationBtn').disabled = false;
                        }
                    });
                } else {
                    // Refresh map size if already initialized
                    locationMap.invalidateSize();
                }
            }, 300);
        }
        
        // Search for location by city name
        async function searchLocation() {
            const cityInput = document.getElementById('citySearch');
            const cityName = cityInput.value.trim();
            const errorDiv = document.getElementById('locationError');
            
            errorDiv.style.display = 'none';
            
            if (!cityName) {
                errorDiv.textContent = 'Please enter a city or marina name';
                errorDiv.style.display = 'block';
                return;
            }
            
            try {
                const response = await fetch(`https://api.openweathermap.org/geo/1.0/direct?q=${encodeURIComponent(cityName)}&limit=1&appid=${apiKey}`);
                const data = await response.json();
                
                if (data.length === 0) {
                    errorDiv.textContent = 'Location not found. Try a different city or marina name.';
                    errorDiv.style.display = 'block';
                    return;
                }
                
                const location = data[0];
                
                // Update map view
                locationMap.setView([location.lat, location.lon], 10);
                
                // Remove existing marker
                if (mapMarker) {
                    locationMap.removeLayer(mapMarker);
                }
                
                // Add marker
                mapMarker = L.marker([location.lat, location.lon]).addTo(locationMap);
                mapMarker.bindPopup(`${location.name}, ${location.country}`).openPopup();
                
                // Store selected location
                selectedLocation = {
                    lat: location.lat,
                    lon: location.lon,
                    name: location.name
                };
                
                // Update info display
                document.getElementById('selectedLocationName').textContent = `${location.name}, ${location.country}`;
                document.getElementById('selectedLat').textContent = location.lat.toFixed(4);
                document.getElementById('selectedLon').textContent = location.lon.toFixed(4);
                document.getElementById('locationInfo').style.display = 'block';
                document.getElementById('setLocationBtn').disabled = false;
                
            } catch (error) {
                errorDiv.textContent = 'Failed to search location. Please try again.';
                errorDiv.style.display = 'block';
            }
        }
        
        // Quick location buttons
        function quickLocation(name, lat, lon) {
            // Update map view
            locationMap.setView([lat, lon], 10);
            
            // Remove existing marker
            if (mapMarker) {
                locationMap.removeLayer(mapMarker);
            }
            
            // Add marker
            mapMarker = L.marker([lat, lon]).addTo(locationMap);
            mapMarker.bindPopup(name).openPopup();
            
            // Store selected location
            selectedLocation = {
                lat: lat,
                lon: lon,
                name: name
            };
            
            // Update info display
            document.getElementById('selectedLocationName').textContent = name;
            document.getElementById('selectedLat').textContent = lat.toFixed(4);
            document.getElementById('selectedLon').textContent = lon.toFixed(4);
            document.getElementById('locationInfo').style.display = 'block';
            document.getElementById('setLocationBtn').disabled = false;
        }
        
        // Use browser's geolocation
        function useCurrentLocation() {
            const errorDiv = document.getElementById('locationError');
            errorDiv.style.display = 'none';
            
            if (!navigator.geolocation) {
                errorDiv.textContent = 'Geolocation is not supported by your browser';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Show loading state
            const geoBtn = document.querySelector('[onclick="useCurrentLocation()"]');
            const originalText = geoBtn.innerHTML;
            geoBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Getting location...';
            geoBtn.disabled = true;
            
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    
                    try {
                        // Update map view
                        locationMap.setView([lat, lon], 12);
                        
                        // Remove existing marker
                        if (mapMarker) {
                            locationMap.removeLayer(mapMarker);
                        }
                        
                        // Add marker
                        mapMarker = L.marker([lat, lon]).addTo(locationMap);
                        
                        // Get city name from coordinates
                        const response = await fetch(`https://api.openweathermap.org/geo/1.0/reverse?lat=${lat}&lon=${lon}&limit=1&appid=${apiKey}`);
                        const data = await response.json();
                        
                        const cityName = data.length > 0 ? data[0].name : 'Current Location';
                        const displayName = data.length > 0 ? `${data[0].name}, ${data[0].country}` : 'Your Current Location';
                        
                        mapMarker.bindPopup(displayName).openPopup();
                        
                        // Store selected location
                        selectedLocation = {
                            lat: lat,
                            lon: lon,
                            name: cityName
                        };
                        
                        // Update info display
                        document.getElementById('selectedLocationName').textContent = displayName;
                        document.getElementById('selectedLat').textContent = lat.toFixed(4);
                        document.getElementById('selectedLon').textContent = lon.toFixed(4);
                        document.getElementById('locationInfo').style.display = 'block';
                        document.getElementById('setLocationBtn').disabled = false;
                        
                    } catch (error) {
                        errorDiv.textContent = 'Failed to get location details. Please try again.';
                        errorDiv.style.display = 'block';
                    } finally {
                        // Restore button state
                        geoBtn.innerHTML = originalText;
                        geoBtn.disabled = false;
                    }
                },
                (error) => {
                    let message = 'Unable to get your location. ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            message += 'Please enable location permissions.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            message += 'Location information unavailable.';
                            break;
                        case error.TIMEOUT:
                            message += 'Location request timed out.';
                            break;
                        default:
                            message += 'Please try again.';
                    }
                    errorDiv.textContent = message;
                    errorDiv.style.display = 'block';
                    
                    // Restore button state
                    geoBtn.innerHTML = originalText;
                    geoBtn.disabled = false;
                }
            );
        }
        
        // Confirm and apply selected location
        async function confirmLocation() {
            if (!selectedLocation) return;
            
            await loadWeather(selectedLocation.lat, selectedLocation.lon, selectedLocation.name);
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('locationModal'));
            modal.hide();
            
            // Reset modal state
            document.getElementById('citySearch').value = '';
            document.getElementById('locationError').style.display = 'none';
            document.getElementById('locationInfo').style.display = 'none';
            document.getElementById('setLocationBtn').disabled = true;
        }
        
        // Allow Enter key to search
        document.getElementById('citySearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchLocation();
            }
        });
        
        // Load weather on page load
        loadWeather();
        
        // Refresh every 15 minutes
        setInterval(loadWeather, 15 * 60 * 1000);
    </script>
</body>
</html>