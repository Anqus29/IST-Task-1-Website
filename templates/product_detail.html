<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ product['title'] }} - Sailor's Bay</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
  <style>
    :root {
      --primary-color: #1e5a8e;
      --ocean-blue: #006994;
      --accent-color: #FF6B35;
      --secondary-color: #f0f8ff;
    }
    .product-image { max-height: 420px; object-fit: contain; width:100%; background:#fff; border:1px solid #eee; padding:8px; }
    .company-statement { background:var(--secondary-color); border-left:4px solid var(--primary-color); padding:12px; margin-top:12px; }
    .stock-badge.low { background:#ffc107; color:#000; }
    .stock-badge.out { background:#dc3545; color:#fff; }

    /* Mobile Responsive Styles */
    @media (max-width: 768px) {
      .product-image {
        max-height: 300px;
      }

      .lead.h4 {
        font-size: 1.5rem;
      }

      h2 {
        font-size: 1.5rem;
      }

      .btn {
        font-size: 0.9rem;
        padding: 0.5rem 1rem;
      }
    }

    @media (max-width: 576px) {
      .product-image {
        max-height: 250px;
      }

      .col-auto input[type="number"] {
        width: 80px !important;
      }

      .row.g-2 {
        flex-direction: column;
      }

      .row.g-2 .col,
      .row.g-2 .col-auto {
        width: 100%;
      }

      .btn {
        width: 100%;
        margin: 5px 0 !important;
      }

      .ms-2 {
        margin-left: 0 !important;
      }
    }
  </style>
</head>
<body class="p-0">
  {% include 'navbar.html' %}

  <div class="container my-4">
    <a href="{{ url_for('products') }}">&laquo; Back to listings</a>

    <div class="row mt-3 g-4">
      <div class="col-md-5">
        {# use mapping test because sqlite3.Row has no .get() #}
  {% if 'image_url' in product.keys() and product['image_url'] %}
          {% set img = product['image_url'] %}
          {% if img.startswith('http://') or img.startswith('https://') or img.startswith('/') %}
            <img src="{{ img }}" class="product-image" alt="{{ product['title'] }}">
          {% else %}
            <img src="{{ url_for('static', filename='img/' ~ img) }}" class="product-image" alt="{{ product['title'] }}">
          {% endif %}
        {% else %}
          <img src="https://via.placeholder.com/600x420?text=No+Image" class="product-image" alt="No image">
        {% endif %}
      </div>

      <div class="col-md-7">
        <h2 class="mb-1">{{ product['title'] }}</h2>
        <div class="mb-2 text-muted">
          <a href="{{ url_for('seller_profile', seller_id=product['seller_id']) }}" class="text-decoration-none">
            {{ product['business_name'] or 'Seller' }}
          </a>
          {% if avg_rating %}
            <span class="ms-2 text-warning">‚òÖ {{ '%.1f'|format(avg_rating) }} ({{ review_count }} review{% if review_count != 1 %}s{% endif %})</span>
          {% elif product['rating'] %}
            <span class="ms-2 text-warning">‚òÖ {{ '%.1f'|format(product['rating']) }}</span>
          {% endif %}
        </div>

        {% if not product.get('is_auction') %}
        <!-- Stock Area -->
        <div class="mb-3">
          <strong>Stock Status:</strong>
          {% if product['stock'] is not none %}
            {% if product['stock'] <= 0 %}
              <span class="badge stock-badge out">Out of stock</span>
            {% elif product['stock'] < 5 %}
              <span class="badge stock-badge low">Only {{ product['stock'] }} left</span>
            {% else %}
              <span class="text-success">In stock ({{ product['stock'] }} available)</span>
            {% endif %}
          {% else %}
            <span class="text-muted">Stock info not available</span>
          {% endif %}
        </div>
        {% endif %}

        {% if not product.get('is_auction') %}
        <!-- Show regular price for non-auction items only -->
        <p class="lead text-success h4">${{ '%.2f'|format(product['price']) }}</p>
        {% endif %}

        {% if product.get('is_auction') %}
        <!-- AUCTION SECTION -->
        <div class="card border-warning mb-3">
          <div class="card-header bg-warning text-dark">
            <h5 class="mb-0">üî® Auction Item - One of a Kind!</h5>
          </div>
          <div class="card-body">
            <div class="row mb-3">
              <div class="col-md-6">
                <strong>Current Bid:</strong>
                <div class="text-success h4">${{ '%.2f'|format(product.get('current_bid') or product.get('starting_bid')) }}</div>
              </div>
              <div class="col-md-6">
                {% if time_remaining and not is_auction_ended %}
                  <strong>Time Remaining:</strong>
                  <div class="text-danger">{{ time_remaining }}</div>
                {% elif is_auction_ended %}
                  <span class="badge bg-danger">Auction Ended</span>
                {% endif %}
              </div>
            </div>

            {% if bid_history and bid_history|length > 0 %}
            <div class="mb-3">
              <strong>Bid History:</strong> {{ bid_history|length }} bid{% if bid_history|length != 1 %}s{% endif %}
              {% if winning_bid %}
                <div class="text-muted small">Winning bidder: {{ winning_bid.bidder.username[:1] }}***</div>
              {% endif %}
            </div>
            {% endif %}

            {% if product.get('reserve_price') %}
            <div class="mb-2">
              <small class="text-muted">
                {% if product.get('current_bid') and product.get('current_bid') >= product.get('reserve_price') %}
                  ‚úÖ Reserve price met
                {% else %}
                  ‚ö†Ô∏è Reserve price not yet met
                {% endif %}
              </small>
            </div>
            {% endif %}

            {% if product.get('buy_now_price') %}
            <div class="alert alert-info small">
              üí° <strong>Buy Now:</strong> ${{ '%.2f'|format(product.get('buy_now_price')) }} - End auction instantly!
            </div>
            {% endif %}

            <!-- Bidding Form -->
            {% if session.get('user_id') %}
              {% if not is_auction_ended %}
                {% if product.get('seller_id') != session.get('user_id') %}
                <form action="{{ url_for('place_bid', product_id=product['id']) }}" method="post">
                  <div class="row g-2">
                    <div class="col-auto">
                      <label class="form-label">Your Bid:</label>
                      <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" name="bid_amount" class="form-control" 
                               step="5.00" 
                               min="{{ (product.get('current_bid') or product.get('starting_bid')) + 5 }}" 
                               value="{{ (product.get('current_bid') or product.get('starting_bid')) + 5 }}"
                               required>
                      </div>
                      <small class="text-muted">Min: ${{ '%.2f'|format((product.get('current_bid') or product.get('starting_bid')) + 5) }} ($5 increment)</small>
                    </div>
                    <div class="col-auto">
                      <label class="form-label">&nbsp;</label>
                      <button type="submit" class="btn btn-warning d-block">Place Bid</button>
                    </div>
                    {% if product.get('buy_now_price') %}
                    <div class="col-auto">
                      <label class="form-label">&nbsp;</label>
                      <button type="button" class="btn btn-success d-block buy-now-btn" 
                              data-buy-now-price="{{ product.get('buy_now_price') }}">
                        Buy Now ${{ '%.2f'|format(product.get('buy_now_price')) }}
                      </button>
                    </div>
                    {% endif %}
                  </div>
                </form>
                
                {% if user_highest_bid %}
                <div class="alert alert-success mt-2 small">
                  ‚úÖ You're currently winning with a bid of ${{ '%.2f'|format(user_highest_bid.bid_amount) }}
                </div>
                {% endif %}
                {% else %}
                <div class="alert alert-warning">
                  You cannot bid on your own auction.
                </div>
                {% endif %}
              {% else %}
                <div class="alert alert-danger">
                  This auction has ended.
                  {% if winning_bid and winning_bid.user_id == session.get('user_id') %}
                    Congratulations, you won!
                  {% endif %}
                </div>
              {% endif %}
            {% else %}
              <a href="{{ url_for('login') }}" class="btn btn-primary">Login to Bid</a>
            {% endif %}
          </div>
        </div>
        <!-- END AUCTION SECTION -->
        
        {% else %}
        <!-- REGULAR PRODUCT ADD TO CART -->
        {% if product['stock'] is not none %}
          {% if product['stock'] <= 0 %}
            <span class="badge stock-badge out">Out of stock</span>
          {% elif product['stock'] < 5 %}
            <span class="badge stock-badge low">{{ product['stock'] }} left</span>
          {% else %}
            <span class="text-muted">In stock</span>
          {% endif %}
        {% endif %}

        <div class="mt-3">
          <form action="{{ url_for('cart_add') }}" method="post" onsubmit="addToCartAjax(event);">
            <input type="hidden" name="product_id" value="{{ product['id'] }}">
            <input type="hidden" name="next" value="{{ request.path }}">
            <div class="row g-2 align-items-center">
              <div class="col-auto">
                <label class="form-label mb-0">Qty</label>
                <input type="number" name="quantity" value="1" min="1" class="form-control" style="width:100px;">
              </div>
              <div class="col">
                <button class="btn btn-primary mt-2" type="submit">Add to cart</button>
                <a href="{{ url_for('cart_view') }}" class="btn btn-outline-secondary mt-2 ms-2">View cart</a>
              </div>
            </div>
          </form>
          
          <!-- Favorite buttons (separate forms, outside cart form) -->
          <div class="mt-2">
            {% if session.get('username') %}
              {% if is_favorited %}
                <form action="{{ url_for('remove_favorite', product_id=product['id']) }}" method="post" style="display:inline;">
                  <button type="submit" class="btn btn-danger" title="Remove from favorites">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-heart-fill" viewBox="0 0 16 16">
                      <path fill-rule="evenodd" d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314z"/>
                    </svg>
                    Unfavorite
                  </button>
                </form>
              {% else %}
                <form action="{{ url_for('add_favorite', product_id=product['id']) }}" method="post" style="display:inline;">
                  <button type="submit" class="btn btn-outline-danger" title="Add to favorites">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-heart" viewBox="0 0 16 16">
                      <path d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01L8 2.748zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143c.06.055.119.112.176.171a3.12 3.12 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15z"/>
                    </svg>
                    Favorite
                  </button>
                </form>
              {% endif %}
            {% else %}
              <a href="{{ url_for('login') }}" class="btn btn-outline-secondary" title="Login to favorite">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-heart" viewBox="0 0 16 16">
                  <path d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01L8 2.748zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143c.06.055.119.112.176.171a3.12 3.12 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15z"/>
                </svg>
                Favorite
              </a>
            {% endif %}
          </div>
        </div>
        {% endif %}
        <!-- END REGULAR PRODUCT SECTION -->

        {% if product['description'] %}
          <hr>
          <h5>Description</h5>
          <p>{{ product['description'] }}</p>
        {% endif %}

        {% if product['seller_description'] or product['business_name'] %}
          <div class="company-statement">
            <strong>About {{ product['business_name'] or product['seller_username'] }}</strong>
            {% if product['seller_description'] %}
              <p class="mb-2">{{ product['seller_description'] }}</p>
            {% else %}
              <p class="mb-2 text-muted">Seller has not added a description.</p>
            {% endif %}
            <div class="small text-muted">
              {% if product['seller_rating'] is not none %}
                ‚≠ê Rating: {{ '%.1f'|format(product['seller_rating']) }}
              {% endif %}
              {% if product['total_sales'] is not none %}
                &middot; {{ product['total_sales'] }} sale{% if product['total_sales'] != 1 %}s{% endif %}
              {% endif %}
            </div>
          </div>
        {% endif %}

        <div class="mt-3">
          <small class="text-muted">Product ID: {{ product['id'] }}</small>
        </div>
      </div>
    </div>

    <hr class="my-4">
    <div class="row">
      <div class="col-md-8">
        <h4 class="mb-3">Customer Reviews</h4>

        {% if reviews and reviews|length > 0 %}
          <div class="list-group mb-4">
            {% for r in reviews %}
              <div class="list-group-item">
                <div class="d-flex justify-content-between">
                  <div>
                    <strong>{{ r['username'] }}</strong>
                    <span class="ms-2 text-warning">{{ '‚òÖ' * r['rating'] }}{% if r['rating'] < 5 %}{{ '‚òÜ' * (5 - r['rating']) }}{% endif %}</span>
                  </div>
                  <small class="text-muted">{{ (r['created_at'] or '')[:10] }}</small>
                </div>
                {% if r['title'] %}
                  <div class="mt-1"><em>{{ r['title'] }}</em></div>
                {% endif %}
                {% if r['body'] %}
                  <p class="mb-0 mt-1">{{ r['body'] }}</p>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="text-muted">No reviews yet. Be the first to review this item.</p>
        {% endif %}

        {% if session.get('username') and can_review %}
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Write a review</h5>
            <form action="{{ url_for('submit_review', product_id=product['id']) }}" method="post">
              <div class="row g-2 align-items-center mb-2">
                <div class="col-auto">
                  <label for="rating" class="col-form-label">Rating</label>
                </div>
                <div class="col-auto">
                  <select class="form-select" name="rating" id="rating" required>
                    <option value="">Select‚Ä¶</option>
                    <option value="5">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ (5)</option>
                    <option value="4">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ (4)</option>
                    <option value="3">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ (3)</option>
                    <option value="2">‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ (2)</option>
                    <option value="1">‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ (1)</option>
                  </select>
                </div>
              </div>
              <div class="mb-2">
                <input class="form-control" type="text" name="title" placeholder="Title (optional)">
              </div>
              <div class="mb-3">
                <textarea class="form-control" name="body" rows="3" placeholder="Share your thoughts (required)" required></textarea>
              </div>
              <button class="btn btn-primary" type="submit">Submit review</button>
            </form>
          </div>
        </div>
        {% elif session.get('username') %}
          <p class="text-muted">Only customers who purchased this item can leave a review.</p>
        {% else %}
          <p><a href="{{ url_for('login', next=request.path) }}">Log in</a> to write a review.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Added-to-cart modal (same as before) -->
  <div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="cartModalLabel">Added to cart</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">Item added. Continue shopping or go to your cart to checkout.</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Continue shopping</button>
          <a href="{{ url_for('cart_view') }}" class="btn btn-primary">Go to cart</a>
        </div>
      </div>
    </div>
  </div>

  <script>
    async function addToCartAjax(e) {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);
      const resp = await fetch(form.action, {
        method: 'POST',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        body: formData
      });
      if (!resp.ok) { form.submit(); return; }
      const data = await resp.json();
      const badge = document.getElementById('cart-count');
      if (badge) badge.textContent = data.total_items || 0;

      // If server reports failure, show an alert and don't show the modal
      if (!data.ok) {
        alert(data.error || 'Could not add item to cart.');
        return;
      }

      // If server added fewer items than requested, inform the user and do not show the modal
      const requested = parseInt(form.querySelector('input[name="quantity"]').value || '1', 10);
      if (typeof data.added !== 'undefined' && data.added < requested) {
        alert(data.message || `Added ${data.added} of ${requested} due to limited stock.`);
        return;
      }

      // All good: show the added-to-cart modal
      const modal = new bootstrap.Modal(document.getElementById('cartModal'));
      modal.show();
    }

    document.addEventListener('DOMContentLoaded', () => {
      fetch('{{ url_for("cart_summary") }}').then(r => r.json()).then(d => {
        const badge = document.getElementById('cart-count');
        if (badge) badge.textContent = d.total_items || 0;
      }).catch(()=>{});

      // Handle Buy Now button for auctions
      const buyNowBtns = document.querySelectorAll('.buy-now-btn');
      buyNowBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          const form = this.closest('form');
          const price = this.getAttribute('data-buy-now-price');
          if (form && form.bid_amount && price) {
            form.bid_amount.value = price;
            form.submit();
          }
        });
      });
    });
  </script>

  {% include 'footer.html' %}
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</body>
<script src="/static/js/theme.js"></script>
</html>